---
- hosts: localhost
  vars:
    container_name: check-yum-update-repo-broken
  tasks:

  - include: tasks/create-test-container.yml

  - name: break the local yum repo
    delegate_to: "{{ container_name }}"
    replace:
      dest: /etc/yum.repos.d/break-yum.repo
      backup: no
      regexp: "^baseurl"
      replace: "#baseurl"

  - command: yum-config-manager --enable break-yum
    delegate_to: "{{ container_name }}"

  - name: test should fail; reports broken repo
    delegate_to: "{{ container_name }}"
    action: check_yum_update
    ignore_errors: True
    register: test_result

  - include: tasks/delete-test-container.yml

  - fail: msg="{{ test_result.msg }}"
    when: test_result|failed
